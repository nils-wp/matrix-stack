version: "3.8"

# =============================================================================
# MATRIX SYNAPSE + ELEMENT + BRIDGES
# Coolify-Ready Setup für 4 User mit WhatsApp, Telegram, Slack Bridges
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # POSTGRESQL DATABASE
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: matrix-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: synapse
      POSTGRES_PASSWORD: ae049c33ff00fc5f97a6bc9b75e1600326f836f5161984d7f00c5e44995d6c59
      POSTGRES_DB: synapse
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U synapse -d synapse"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - matrix-internal

  # ---------------------------------------------------------------------------
  # SYNAPSE HOMESERVER
  # ---------------------------------------------------------------------------
  synapse:
    image: matrixdotorg/synapse:latest
    container_name: matrix-synapse
    restart: unless-stopped
    user: "root"
    entrypoint: ["/bin/sh", "-c", "chown -R 991:991 /data && exec /start.py"]
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SYNAPSE_CONFIG_DIR: /config
      SYNAPSE_CONFIG_PATH: /config/homeserver.yaml
    volumes:
      - synapse_data:/data
    configs:
      - source: homeserver_config
        target: /config/homeserver.yaml
      - source: log_config
        target: /config/log.config
      - source: whatsapp_registration
        target: /config/bridges/whatsapp.yaml
      - source: telegram_registration
        target: /config/bridges/telegram.yaml
      - source: slack_registration
        target: /config/bridges/slack.yaml
    healthcheck:
      test: ["CMD", "curl", "-fSs", "http://localhost:8008/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - matrix-internal

  # ---------------------------------------------------------------------------
  # ELEMENT WEB CLIENT
  # ---------------------------------------------------------------------------
  element:
    image: vectorim/element-web:latest
    container_name: matrix-element
    restart: unless-stopped
    depends_on:
      - synapse
    configs:
      - source: element_config
        target: /app/config.json
    networks:
      - matrix-internal

  # ---------------------------------------------------------------------------
  # DIMENSION - Integration Manager
  # ---------------------------------------------------------------------------
  dimension:
    image: turt2live/matrix-dimension:latest
    container_name: matrix-dimension
    restart: unless-stopped
    depends_on:
      - synapse
    volumes:
      - dimension_data:/data
    configs:
      - source: dimension_config
        target: /data/config.yaml
    networks:
      - matrix-internal

  # ---------------------------------------------------------------------------
  # SYNAPSE ADMIN UI
  # ---------------------------------------------------------------------------
  synapse-admin:
    image: awesometechnologies/synapse-admin:latest
    container_name: matrix-admin
    restart: unless-stopped
    depends_on:
      - synapse
    environment:
      REACT_APP_SERVER: "https://matrix.wolfbraun.link"
      # Domain: admin.matrix.wolfbraun.link:80
    networks:
      - matrix-internal

  # ---------------------------------------------------------------------------
  # WELL-KNOWN DELEGATION (für @user:domain.de statt @user:matrix.domain.de)
  # ---------------------------------------------------------------------------
  well-known:
    image: nginx:alpine
    container_name: matrix-wellknown
    restart: unless-stopped
    configs:
      - source: wellknown_nginx_config
        target: /etc/nginx/conf.d/default.conf
      - source: wellknown_client
        target: /usr/share/nginx/html/.well-known/matrix/client
      - source: wellknown_server
        target: /usr/share/nginx/html/.well-known/matrix/server
    networks:
      - matrix-internal

  # ---------------------------------------------------------------------------
  # MAUTRIX-WHATSAPP BRIDGE
  # ---------------------------------------------------------------------------
  whatsapp-bridge:
    image: dock.mau.dev/mautrix/whatsapp:latest
    container_name: matrix-whatsapp
    restart: unless-stopped
    depends_on:
      - synapse
    environment:
      MAUTRIX_DIRECT_STARTUP: "true"
    volumes:
      - whatsapp_data:/data
    configs:
      - source: whatsapp_config
        target: /data/config.yaml
      - source: whatsapp_registration
        target: /data/registration.yaml
    networks:
      - matrix-internal

  # ---------------------------------------------------------------------------
  # MAUTRIX-TELEGRAM BRIDGE
  # ---------------------------------------------------------------------------
  telegram-bridge:
    image: dock.mau.dev/mautrix/telegram:latest
    container_name: matrix-telegram
    restart: unless-stopped
    depends_on:
      - synapse
    volumes:
      - telegram_data:/data
    configs:
      - source: telegram_config
        target: /data/config.yaml
    networks:
      - matrix-internal

  # ---------------------------------------------------------------------------
  # MAUTRIX-SLACK BRIDGE
  # ---------------------------------------------------------------------------
  slack-bridge:
    image: dock.mau.dev/mautrix/slack:latest
    container_name: matrix-slack
    restart: unless-stopped
    depends_on:
      - synapse
    volumes:
      - slack_data:/data
    configs:
      - source: slack_config
        target: /data/config.yaml
      - source: slack_registration
        target: /data/registration.yaml
    networks:
      - matrix-internal

# =============================================================================
# CONFIGS (Inline-Konfigurationsdateien)
# =============================================================================
configs:
  homeserver_config:
    content: |
      server_name: "wolfbraun.link"
      public_baseurl: "https://matrix.wolfbraun.link/"
      listeners:
        - port: 8008
          tls: false
          type: http
          x_forwarded: true
          bind_addresses: ['0.0.0.0']
          resources:
            - names: [client, federation]
              compress: false
      database:
        name: psycopg2
        args:
          user: synapse
          password: "ae049c33ff00fc5f97a6bc9b75e1600326f836f5161984d7f00c5e44995d6c59"
          database: synapse
          host: postgres
          port: 5432
          cp_min: 5
          cp_max: 10
      log_config: "/config/log.config"
      media_store_path: /data/media_store
      max_upload_size: 50M
      url_preview_enabled: true
      url_preview_ip_range_blacklist:
        - '127.0.0.0/8'
        - '10.0.0.0/8'
        - '172.16.0.0/12'
        - '192.168.0.0/16'
        - '100.64.0.0/10'
        - '192.0.0.0/24'
        - '169.254.0.0/16'
        - '192.88.99.0/24'
        - '198.18.0.0/15'
        - '192.0.2.0/24'
        - '198.51.100.0/24'
        - '203.0.113.0/24'
        - '224.0.0.0/4'
        - '::1/128'
        - 'fe80::/10'
        - 'fc00::/7'
        - '2001:db8::/32'
        - 'ff00::/8'
        - 'fec0::/10'
      enable_registration: false
      registration_shared_secret: "a77f74e4e53032e343b4eb906b86d393399b59e0f888a61e1e9e217eb8954b04"
      use_presence: false
      enable_search: true
      rc_message:
        per_second: 5
        burst_count: 25
      rc_registration:
        per_second: 0.1
        burst_count: 3
      rc_login:
        address:
          per_second: 0.5
          burst_count: 5
        account:
          per_second: 0.5
          burst_count: 5
      signing_key_path: "/data/signing.key"
      trusted_key_servers:
        - server_name: "matrix.org"
      suppress_key_server_warning: true
      report_stats: false
      app_service_config_files:
        - /config/bridges/whatsapp.yaml
        - /config/bridges/telegram.yaml
        - /config/bridges/slack.yaml
      retention:
        enabled: true
        default_policy:
          min_lifetime: 1d
          max_lifetime: 365d
      media_retention:
        local_media_lifetime: 180d
        remote_media_lifetime: 14d
      macaroon_secret_key: "9b881b8f74f34f98c86bb0d49704862f810cc6f83654e4f35da1433434f52374"
      form_secret: "07a9bf2bd0682bfffa9061479a741eacf33fe94fc3a3d238cf1fc1af360ef4f3"

  log_config:
    content: |
      version: 1
      formatters:
        precise:
          format: '%(asctime)s - %(name)s - %(lineno)d - %(levelname)s - %(request)s - %(message)s'
      handlers:
        console:
          class: logging.StreamHandler
          formatter: precise
      loggers:
        synapse.storage.SQL:
          level: WARNING
      root:
        level: WARNING
        handlers: [console]
      disable_existing_loggers: false

  element_config:
    content: |
      {
        "default_server_config": {
          "m.homeserver": {
            "base_url": "https://matrix.wolfbraun.link",
            "server_name": "wolfbraun.link"
          }
        },
        "brand": "Wachstumspartner Chat",
        "integrations_ui_url": "https://dimension.matrix.wolfbraun.link/element",
        "integrations_rest_url": "https://dimension.matrix.wolfbraun.link/api/v1/scalar",
        "integrations_widgets_urls": ["https://dimension.matrix.wolfbraun.link/widgets"],
        "integrations_jitsi_widget_url": "https://dimension.matrix.wolfbraun.link/widgets/jitsi",
        "disable_custom_urls": false,
        "disable_guests": true,
        "disable_login_language_selector": false,
        "disable_3pid_login": true,
        "default_country_code": "DE",
        "show_labs_settings": true,
        "features": {
          "feature_video_rooms": true,
          "feature_element_call_video_rooms": true,
          "feature_group_calls": true
        },
        "default_theme": "dark",
        "room_directory": {
          "servers": ["wolfbraun.link"]
        },
        "setting_defaults": {
          "breadcrumbs": true
        },
        "jitsi": {
          "preferred_domain": "meet.element.io"
        }
      }

  wellknown_nginx_config:
    content: |
      server {
          listen 80;
          server_name _;
          location /.well-known/matrix/ {
              root /usr/share/nginx/html;
              default_type application/json;
              add_header Access-Control-Allow-Origin *;
              add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
              add_header Access-Control-Allow-Headers "X-Requested-With, Content-Type, Authorization";
          }
      }

  wellknown_client:
    content: |
      {
        "m.homeserver": {
          "base_url": "https://matrix.wolfbraun.link"
        }
      }

  wellknown_server:
    content: |
      {
        "m.server": "matrix.wolfbraun.link:443"
      }

  whatsapp_config:
    content: |
      homeserver:
        address: http://synapse:8008
        domain: wolfbraun.link
      appservice:
        address: http://whatsapp-bridge:29318
        hostname: 0.0.0.0
        port: 29318
        id: whatsapp
        bot:
          username: whatsappbot
          displayname: WhatsApp Bridge Bot
          avatar: mxc://maunium.net/NeXNQarUbrlYBiPCpprYsRqr
        as_token: 64186ce369b4610d38166a1ca1d076ac7d52086a91738803fa5b3425390fefad
        hs_token: ab74d7b08c04dfb8bdba2a9d9d57d8bca480bbfd4eb5adb2dd4c8a6f0fac9f57
      database:
        type: sqlite3-fk-wal
        uri: file:/data/whatsapp.db?_txlock=immediate
      bridge:
        command_prefix: "!wa"
        permissions:
          "*": relay
          "wolfbraun.link": user
          "@admin:wolfbraun.link": admin
          "@wolf:wolfbraun.link": admin
      whatsapp:
        os_name: Mautrix-WhatsApp bridge
        browser_name: unknown
      logging:
        min_level: debug
        writers:
          - type: stdout
            format: pretty-colored

  whatsapp_registration:
    content: |
      id: whatsapp
      url: http://whatsapp-bridge:29318
      as_token: 64186ce369b4610d38166a1ca1d076ac7d52086a91738803fa5b3425390fefad
      hs_token: ab74d7b08c04dfb8bdba2a9d9d57d8bca480bbfd4eb5adb2dd4c8a6f0fac9f57
      sender_localpart: whatsappbot
      rate_limited: false
      namespaces:
        users:
          - regex: ^@whatsapp_.*:wolfbraun\.link$
            exclusive: true
          - regex: ^@whatsappbot:wolfbraun\.link$
            exclusive: true

  telegram_config:
    content: |
      homeserver:
        address: http://synapse:8008
        domain: wolfbraun.link
      appservice:
        address: http://telegram-bridge:29317
        hostname: 0.0.0.0
        port: 29317
        database: sqlite:////data/telegram.db
        id: telegram
        bot:
          username: telegrambot
          displayname: Telegram Bridge Bot
        as_token: 3981027b234d7fb7bb93b5a532a4db1998755ff0a0e331bcddefa063871beb1e
        hs_token: 9c27ab266cff7b9bfc31a4ccd7a431460f192604f1d6cfce52e6059dec56300b
      telegram:
        api_id: 30932921
        api_hash: a68ab2101013d0409759fe4aa7dcd8a5
        bot_token: 8576271750:AAG7rT-8jyRS-zmXTlqVVo2Jc0lhIsiPFUw
      bridge:
        username_template: telegram_{userid}
        displayname_template: "{displayname} (TG)"
        permissions:
          "*": relaybot
          "wolfbraun.link": user
          "@admin:wolfbraun.link": admin
          "@wolf:wolfbraun.link": admin
      logging:
        version: 1
        formatters:
          colored:
            (): mautrix.util.logging.color.ColorFormatter
            format: "[%(asctime)s] [%(levelname)s@%(name)s] %(message)s"
        handlers:
          console:
            class: logging.StreamHandler
            formatter: colored
        loggers:
          mau:
            level: DEBUG
          telethon:
            level: INFO
        root:
          level: DEBUG
          handlers: [console]

  telegram_registration:
    content: |
      id: telegram
      url: http://telegram-bridge:29317
      as_token: 3981027b234d7fb7bb93b5a532a4db1998755ff0a0e331bcddefa063871beb1e
      hs_token: 9c27ab266cff7b9bfc31a4ccd7a431460f192604f1d6cfce52e6059dec56300b
      sender_localpart: telegrambot
      rate_limited: false
      namespaces:
        users:
          - regex: ^@telegram_.*:wolfbraun\.link$
            exclusive: true
          - regex: ^@telegrambot:wolfbraun\.link$
            exclusive: true

  slack_config:
    content: |
      homeserver:
        address: http://synapse:8008
        domain: wolfbraun.link
      appservice:
        address: http://slack-bridge:29312
        hostname: 0.0.0.0
        port: 29312
        id: slack
        bot:
          username: slackbot
          displayname: Slack Bridge Bot
        as_token: 26371968395178088bcb4faec2603a36b850752a40800f465855a9a8843328bf
        hs_token: 6baf5498499c17c5e9ef060bfa07ebe673590526f4304846bec40b19c9e28306
      database:
        type: sqlite3-fk-wal
        uri: file:/data/slack.db?_txlock=immediate
      bridge:
        command_prefix: "!slack"
        permissions:
          "*": relay
          "wolfbraun.link": user
          "@admin:wolfbraun.link": admin
          "@wolf:wolfbraun.link": admin
      logging:
        min_level: debug
        writers:
          - type: stdout
            format: pretty-colored

  slack_registration:
    content: |
      id: slack
      url: http://slack-bridge:29312
      as_token: 26371968395178088bcb4faec2603a36b850752a40800f465855a9a8843328bf
      hs_token: 6baf5498499c17c5e9ef060bfa07ebe673590526f4304846bec40b19c9e28306
      sender_localpart: slackbot
      rate_limited: false
      namespaces:
        users:
          - regex: ^@slack_.*:wolfbraun\.link$
            exclusive: true
          - regex: ^@slackbot:wolfbraun\.link$
            exclusive: true

  dimension_config:
    content: |
      web:
        port: 8184
        address: "0.0.0.0"
      homeserver:
        name: "wolfbraun.link"
        clientServerUrl: "http://synapse:8008"
        federationUrl: "http://synapse:8008"
        accessToken: "syt_ZGltZW5zaW9u_RyHsHDteTxqcPYGYDmjF_3EPcLH"
      admins:
        - "@admin:wolfbraun.link"
      widgetBlacklist: []
      database:
        file: "/data/dimension.db"
      logging:
        file: "/data/dimension.log"
        console: true
        consoleLevel: warn
        fileLevel: info
        rotate:
          size: 52428800
          count: 5

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  postgres_data:
  synapse_data:
  whatsapp_data:
  telegram_data:
  slack_data:
  dimension_data:

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  matrix-internal:
    driver: bridge
